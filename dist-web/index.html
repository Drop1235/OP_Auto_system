<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MatchDrop - ãƒ†ãƒ‹ã‚¹ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå¯¾æˆ¦è¡¨</title>
  <link rel="stylesheet" href="src/css/styles.css">
  <link rel="stylesheet" href="src/css/tournament-modal.css">
  <!-- matchData ä¿å­˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ -->
  <script src="src/js/matchDropStorage.js"></script>
  <!-- ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ -->
  <script src="src/js/local-storage.js"></script>
  <link rel="icon" href="assets/icon.png">

  <style>
    /* Netlifyé–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ */
    [data-mode="viewer"] nav,
    [data-mode="viewer"] button,
    [data-mode="viewer"] select,
    [data-mode="viewer"] input,
    [data-mode="viewer"] .modal,
    [data-mode="viewer"] main {
      display: none !important;
    }
    [data-mode="viewer"] #screenshot-container {
      display: block !important;
    }
  </style>

</head>
<body>
  <script>
    // --- Viewer mode detection (Netlify = read-only) ---
    const IS_VIEWER = location.hostname.includes("netlify.app");
    if (IS_VIEWER) {
      // data-modeãƒ•ãƒ©ã‚°ã‚’<html>ã«è¨­å®šï¼ˆCSSåˆ¶å¾¡ç”¨ï¼‰
      document.documentElement.dataset.mode = "viewer";
      window.addEventListener("DOMContentLoaded", () => {
        // ã‚¹ã‚¯ã‚·ãƒ§è¡¨ç¤º
        const sc = document.getElementById("screenshot-container");
        if (sc) {
          sc.style.display = "block";
          const img = sc.querySelector("img");
          if (img) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã§å¸¸ã«æœ€æ–°å–å¾—
            img.src = "screenshot.png?ts=" + Date.now();
          }
        }
        // main/ãƒŠãƒ“/ãƒœã‚¿ãƒ³é¡ã‚’éè¡¨ç¤ºï¼ˆä¿é™ºçš„åˆ¶å¾¡ã€‚CSSã§ã‚‚éè¡¨ç¤ºï¼‰
        const main = document.querySelector("main");
        if (main) main.style.display = "none";
        const nav = document.querySelector("header nav");
        if (nav) nav.style.display = "none";
      }, { once: true });
    }
  </script>
  <!-- æ–°è¦å¤§ä¼šåå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="tournament-modal">
    <div class="modal-content">
      <h2>æ–°è¦å¤§ä¼šä½œæˆ</h2>
      <label for="tournament-name-input">å¤§ä¼šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
      <input type="text" id="tournament-name-input" maxlength="30" autocomplete="off" />
      <div class="modal-btns">
        <button class="ok-btn" id="tournament-modal-ok">OK</button>
        <button class="cancel-btn" id="tournament-modal-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <header>
    <div class="app-brand">
      <img src="assets/icon.png" alt="MatchDrop icon" class="logo-icon">
      <span class="app-name">MatchDrop</span>

    </div>
    <nav style="display: flex; align-items: center; gap: 8px;">
      <button id="board-view-btn" class="active">å¯¾æˆ¦è¡¨</button>
      <button id="history-view-btn">è©¦åˆå±¥æ­´</button>
      <label for="tournament-select" style="margin-left: 16px;">å¤§ä¼š:</label>
      <select id="tournament-select" style="min-width: 150px;"></select>
      <button id="add-tournament-btn" style="background-color: #2196f3; color: #fff;">æ–°è¦å¤§ä¼š</button>
      <button id="delete-tournament-btn" title="å¤§ä¼šã‚’å‰Šé™¤" style="background: none; border: none; cursor: pointer; font-size: 1.3em; color: #f44336; padding: 0 8px;">ğŸ—‘ï¸</button>
      
      <button id="logout-btn" style="margin-left: 8px; background-color: #f44336;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      <button id="settings-btn" title="è¨­å®š" style="margin-left: 8px;">âš™</button>
      <button id="publish-btn" style="margin-left: 8px; background-color: #4caf50; color:#fff;">ğŸ“¤ å…¬é–‹</button>
    </nav>
  </header>

  <!-- å…¬é–‹ç”¨ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè¡¨ç¤ºï¼ˆNetlifyï¼‰-->
  <div id="screenshot-container" style="display:none; text-align:center; padding:8px;">
    <img src="screenshot.png" alt="Published Screenshot" style="max-width:100%; height:auto;">
    <p style="margin-top:4px;font-size:0.85em;color:#666;">ã“ã®ãƒšãƒ¼ã‚¸ã¯é–²è¦§å°‚ç”¨ã§ã™ï¼ˆç·¨é›†ã¯Electronã‚¢ãƒ—ãƒªã‹ã‚‰è¡Œã£ã¦ãã ã•ã„ï¼‰ã€‚</p>
  </div>

  <main>
    <!-- Board View -->
    <section id="board-view" class="active-view">
      <!-- ã‚³ãƒ¼ãƒˆè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div id="court-settings" class="court-settings">
        <div class="court-settings-header">
          <button id="add-match-btn" class="add-match-btn-prominent">è©¦åˆè¿½åŠ </button>
          <div class="court-count-controls" style="margin-left:auto; margin-right:8px;">
            <button id="decrease-courts-btn">-</button>
            <span id="court-count-display" class="court-count-display">12</span>
            <button id="increase-courts-btn">+</button>
          </div>
          
          <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
          <div class="export-controls" style="margin-right:8px;">
            <select id="board-export-type" style="margin-right:4px;">
              <option value="csv">CSVå½¢å¼</option>
              <option value="screenshot">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ</option>
            </select>
            <button id="board-export-btn" class="export-btn">æ›¸ãå‡ºã—</button>
          </div>
          
          <button id="delete-all-matches-btn" class="delete-all-btn">å…¨å‰Šé™¤</button>
      </div>
      <div id="court-grid" class="court-grid"></div>
      
      <!-- æœªå‰²å½“ã®ã‚«ãƒ¼ãƒ‰ç”¨ã®æ  -->
      <div class="unassigned-section">
        <div class="unassigned-header">æœªå‰²å½“ã®è©¦åˆ</div>
        <div id="unassigned-cards" class="unassigned-cards">
          <!-- æœªå‰²å½“ã®ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
      </div>
    </section>

    <!-- History View -->
    <section id="history-view" class="hidden-view">
      <div class="filter-controls">
        <div class="filter-group">
          <label for="court-filter">ã‚³ãƒ¼ãƒˆ:</label>
          <select id="court-filter">
            <option value="all">å…¨ã‚³ãƒ¼ãƒˆ</option>
            <!-- Courts will be populated dynamically -->
          </select>
        </div>
        <div class="filter-group">
          <label for="date-filter">æ—¥ä»˜:</label>
          <input type="date" id="date-filter">
          <button id="clear-date-filter">ã‚¯ãƒªã‚¢</button>
        </div>
        </div>
      </div>
      
      <!-- ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ (ã“ã‚ŒãŒå”¯ä¸€ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«ãªã‚‹) -->
      <div id="history-card-view" class="history-card-view">
        <div id="history-court-grid" class="court-grid history-court-grid">
          <!-- å±¥æ­´ã‚³ãƒ¼ãƒˆã‚°ãƒªãƒƒãƒ‰ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>
      </div>
    </section>
  </main>

  <!-- Add Match Modal -->
  <div id="add-match-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>æ–°è¦è©¦åˆè¿½åŠ </h2>
      <form id="add-match-form">
        <div class="form-group">
          <label>è©¦åˆå½¢å¼:</label>
          <select id="game-format-select" name="game-format" class="form-control">
            <option value="5game">5G</option>
            <option value="4game1set">4G1set</option>
            <option value="6game1set">6G1set</option>
            <option value="8game1set">8G-Pro</option>
            <option value="4game2set">4G2set+10MTB</option>
            <option value="6game2set">6G2set+10MTB</option>
            <option value="4game3set">4G3set</option>
            <option value="6game3set">6G3set</option>
          </select>
        </div>
        <div class="form-group">
          <label for="player-a">é¸æ‰‹A:</label>
          <input type="text" id="player-a" required>
        </div>
        <div class="form-group">
          <label for="player-b">é¸æ‰‹B:</label>
          <input type="text" id="player-b" required>
        </div>
        <!-- äºˆå®šé–‹å§‹æ™‚åˆ»æ¬„ã‚’å‰Šé™¤ -->
        <div class="form-group">
          <label for="court-select">ã‚³ãƒ¼ãƒˆ (ä»»æ„):</label>
          <select id="court-select">
            <option value="">æœªå‰²å½“</option>
            <!-- Courts will be populated dynamically -->
          </select>
        </div>
        <div class="form-group">
          <label for="position-select">ä½ç½® (ä»»æ„):</label>
          <select id="position-select">
            <option value="">æœªå‰²å½“</option>
            <option value="current">ç¾åœ¨ã®è©¦åˆ</option>
            <option value="next">æ¬¡ã®è©¦åˆ</option>
            <option value="next2">æ¬¡ã€…ã®è©¦åˆ</option>
          </select>
        </div>
        <button type="submit">è¿½åŠ </button>
      </form>
    </div>
  </div>

  <!-- html2canvas for screenshot functionality -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’æœ€åˆã«èª­ã¿è¾¼ã¿ -->
  <script>
    console.log('[INIT] Loading LocalStorageManager...');
  </script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="src/js/firebase-config.js"></script>  
  <script src="src/js/FirestoreMatchDatabase.js"></script>

  <script src="src/js/favicon.js"></script>
  <script src="src/js/database.js"></script>
  <script src="src/js/matchCard.js"></script>
  <script src="src/js/board.js"></script>
  <script src="src/js/history.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="src/js/app.js"></script>
  <!--
  <script>
    if (location.hostname.includes("netlify.app")) {
      const script = document.createElement("script");
      script.src = "src/js/netlify-ui.js";
      document.body.appendChild(script);
    }
  </script>
  -->
  <script src="src/js/auth.js"></script>
  <script src="src/js/viewer-mode.js"></script>
  <script src="src/js/publish-ipc.js"></script>
  <script src="src/js/settings-manager.js"></script>
  <!-- Settings dialog loader -->
  <script type="module">
    const btn = document.getElementById('settings-btn');
    if (btn) {
      import('./src/js/settings-manager.js').then(mod => {
        btn.addEventListener('click', () => mod.showSettingsDialog());
      }).catch(err => console.error('Failed to load settings-manager', err));
    }
  </script>
  
  <!-- For web-only version (will be removed in Electron build) -->
  <footer class="web-footer">
    <p>ãƒ†ãƒ‹ã‚¹ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå¯¾æˆ¦è¡¨ - ã‚¦ã‚§ãƒ–ç‰ˆ</p>
    <p><small>ã“ã‚Œã¯ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ã‚¦ã‚§ãƒ–ç‰ˆã§ã™ã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã®ä½¿ç”¨ã«ã¯Electronã‚¢ãƒ—ãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</small></p>
  </footer>
</body>
</html>
